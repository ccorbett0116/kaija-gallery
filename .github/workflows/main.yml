name: build-push-deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Env/service to deploy (matches target container)"
        required: true
        default: production

concurrency:
  group: deploy-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'production' }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  TARGET_ENV: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'production' }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image: ${{ steps.deploy-meta.outputs.image }}
      tag: ${{ steps.deploy-meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Set deploy image/tag outputs
        id: deploy-meta
        run: |
          echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}" >> "$GITHUB_OUTPUT"
          echo "tag=latest" >> "$GITHUB_OUTPUT"

  deploy:
    needs: build-and-push
    runs-on: [self-hosted, docker, linux]
    environment:
      name: ${{ env.TARGET_ENV }}
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest image
        env:
          IMAGE: ${{ needs.build-and-push.outputs.image }}
          TAG: ${{ needs.build-and-push.outputs.tag }}
        run: |
          echo "Pulling ${IMAGE}:${TAG}..."
          docker pull "${IMAGE}:${TAG}"

      - name: Stop and remove existing container
        run: |
          CONTAINER_NAME="${{ secrets.CONTAINER_NAME || 'kaija-app' }}"
          if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
            echo "Stopping existing container: ${CONTAINER_NAME}"
            docker stop "${CONTAINER_NAME}" || true
            docker rm "${CONTAINER_NAME}" || true
          else
            echo "No existing container found"
          fi

      - name: Start new container
        env:
          IMAGE: ${{ needs.build-and-push.outputs.image }}
          TAG: ${{ needs.build-and-push.outputs.tag }}
          CONTAINER_NAME: ${{ secrets.CONTAINER_NAME || 'kaija-app' }}
          RUN_ARGS: ${{ secrets.DOCKER_RUN_ARGS || '-p 80:80' }}
        run: |
          echo "Starting container: ${CONTAINER_NAME}"
          docker run -d \
            --name "${CONTAINER_NAME}" \
            --restart unless-stopped \
            ${RUN_ARGS} \
            "${IMAGE}:${TAG}"

          echo "Waiting for container to start..."
          sleep 3

      - name: Verify deployment
        env:
          CONTAINER_NAME: ${{ secrets.CONTAINER_NAME || 'kaija-app' }}
        run: |
          echo "Container status:"
          docker ps --filter "name=${CONTAINER_NAME}" --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}'

          if docker ps --filter "name=${CONTAINER_NAME}" --format '{{.Names}}' | grep -q "${CONTAINER_NAME}"; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed - container not running"
            exit 1
          fi
